# Vibecraft Framework — Integration Guide

## Introduction

Это руководство описывает процесс интеграции модулей в Vibecraft Framework Modular Mode, включая анализ зависимостей и построение интеграционного слоя.

## Integration Overview

Интеграция модулей включает:

1. **Анализ зависимостей** — проверка корректности зависимостей между модулями
2. **Обнаружение циклов** — выявление циклических зависимостей
3. **Построение порядка сборки** — определение последовательности build
4. **Генерация интерфейсов** — создание общих интерфейсов для экспортов
5. **Генерация коннекторов** — создание коннекторов между модулями

## Dependency Analysis

### Запуск анализа

```bash
vibecraft integrate analyze
```

### Что проверяется

1. **Существующие зависимости**
   - Все declared зависимости существуют
   - Нет зависимостей от несуществующих модулей

2. **Циклические зависимости**
   - A → B → A (прямой цикл)
   - A → B → C → A (косвенный цикл)

3. **Отсутствующие экспорты**
   - Модуль экспортирует то, что использует другой модуль

### Пример отчёта

```
=== Dependency Analysis Report ===

Modules: 5
  - database (completed)
  - config (completed)
  - auth (in_progress)
  - users (planned)
  - api (planned)

Dependencies:
  database → []
  config → []
  auth → [database, config]
  users → [auth, database]
  api → [auth, users, billing]

Build Order:
  1. database
  2. config
  3. auth
  4. users
  5. api

Issues:
  ❌ Module 'api' depends on 'billing' which does not exist
  
Status: FAILED - 1 issue(s) found
```

### Исправление проблем

#### Issue: Missing dependency

```
❌ Module 'api' depends on 'billing' which does not exist
```

**Solution**:
```bash
# Создать недостающий модуль
vibecraft module create billing -d "Billing and payments"

# Или удалить зависимость
# Edit modules/api/.module.json и удалить 'billing' из dependencies
```

#### Issue: Circular dependency

```
❌ Circular dependency detected: auth → users → auth
```

**Solution**:
1. Выделите общую логику в новый модуль
2. Перестройте зависимости

```bash
# Создать общий модуль
vibecraft module create auth_users_common -d "Shared auth/users types"

# Обновить зависимости
# auth → auth_users_common
# users → auth_users_common
# auth ↛ users (удалить прямую зависимость)
```

## Build Order

### Как определяется порядок

Modular Mode использует **topological sort** для определения порядка сборки:

1. Модули без зависимостей → первые
2. Модули, зависящие только от completed → следующие
3. Повторять пока все модули не упорядочены

### Пример

```
Dependencies:
  database → []
  config → []
  auth → [database, config]
  users → [auth, database]
  api → [auth, users]

Build Order:
  1. database  (no deps)
  2. config    (no deps)
  3. auth      (depends on 1, 2)
  4. users     (depends on 1, 3)
  5. api       (depends on 3, 4)
```

### Использование build order

Разрабатывайте модули в порядке build order:

```bash
# 1. Разработать database
vibecraft run implement --phase 1 --module database
vibecraft run implement --phase 2 --module database
vibecraft module status database  # должен быть completed

# 2. Разработать config
# ...

# 3. Разработать auth (теперь зависимости готовы)
# ...
```

## Interface Generation

### Что такое интерфейсы

Интерфейсы — это Protocol-классы, которые описывают публичные экспорты модулей:

```python
# integration/interfaces.py
# Auto-generated by Vibecraft

from typing import Protocol


class DatabaseConnection(Protocol):
    """Interface from module: database"""
    
    def connect(self) -> None:
        ...
    
    def execute(self, query: str) -> list:
        ...


class AuthService(Protocol):
    """Interface from module: auth"""
    
    def login(self, username: str, password: str) -> str:
        ...
    
    def logout(self, token: str) -> None:
        ...
```

### Генерация интерфейсов

```bash
vibecraft integrate build
```

Это создаст:
- `integration/interfaces.py` — все интерфейсы
- `integration/connectors/` — коннекторы между модулями

### Использование интерфейсов

В ваших модулях:

```python
# modules/users/src/user_service.py

from integration.interfaces import AuthService, DatabaseConnection

class UserService:
    def __init__(self, auth: AuthService, db: DatabaseConnection):
        self.auth = auth
        self.db = db
    
    def get_current_user(self, token: str) -> dict:
        # Использовать auth для валидации токена
        user_id = self.auth.verify_token(token)
        # Использовать db для получения данных
        return self.db.execute("SELECT * FROM users WHERE id = ?", user_id)
```

## Connector Generation

### Что такое коннекторы

Коннекторы — это классы, которые соединяют модули:

```python
# integration/connectors/auth_database_connector.py

from modules.database.src.connection import DatabaseConnection
from modules.auth.src.services.auth_service import AuthService

class AuthDatabaseConnector:
    """Connector between auth and database modules."""
    
    def __init__(self, db: DatabaseConnection):
        self.db = db
        self.auth_service = AuthService(db)
    
    def authenticate_user(self, username: str, password: str) -> bool:
        return self.auth_service.login(username, password)
```

### Структура connectors

```
integration/connectors/
├── __init__.py
├── auth_database_connector.py
├── users_auth_connector.py
└── api_users_connector.py
```

## Integration Workflow

### Полный workflow интеграции

```bash
# 1. Создать все модули
vibecraft module create database -d "Database layer"
vibecraft module create config -d "Configuration"
vibecraft module create auth -d "Authentication" --depends-on database,config
vibecraft module create users -d "User management" --depends-on auth,database

# 2. Инициализировать модули
vibecraft module init database
vibecraft module init config
vibecraft module init auth
vibecraft module init users

# 3. Проверить зависимости
vibecraft integrate analyze

# 4. Разработать модули в build order
# ... TDD для каждого модуля ...

# 5. Построить интеграционный слой
vibecraft integrate build

# 6. Проверить интеграцию
pytest integration/ -v
```

## Troubleshooting

### Issue: Interfaces not generated

**Cause**: Нет completed модулей с экспортами

**Solution**:
```bash
# Проверить статус модулей
vibecraft module list

# Завершить хотя бы один модуль
vibecraft run implement --phase N --module database
vibecraft module status database  # должен быть completed

# Построить интеграцию
vibecraft integrate build
```

### Issue: Connector import errors

**Cause**: Модуль ещё не имеет исходного кода

**Solution**:
```bash
# Убедиться, что модуль имеет src/
vibecraft module status <module>

# Если src/ пуст → запустить implement
vibecraft run implement --phase 1 --module <module>
```

### Issue: Circular import

**Cause**: Прямые импорты между модулями создают цикл

**Solution**:
```python
# ❌ Bad: Прямой импорт
from modules.auth.src.services import AuthService

# ✅ Good: Импорт через интерфейс
from integration.interfaces import AuthService
```

## Best Practices

### 1. Используйте интерфейсы, не реализации

✅ **Good**:
```python
from integration.interfaces import AuthService
```

❌ **Bad**:
```python
from modules.auth.src.services.auth_service import AuthService
```

### 2. Обновляйте интеграцию после изменений

После добавления нового экспорта:
```bash
vibecraft integrate build
```

### 3. Тестируйте интеграцию

Создайте integration тесты:
```python
# integration/test_full_workflow.py

def test_auth_with_database():
    """Test auth module integrates with database."""
    db = DatabaseConnection()
    auth = AuthService(db)
    
    token = auth.login("test", "password")
    assert token is not None
```

### 4. Документируйте зависимости

В `.module.json`:
```json
{
  "dependencies": ["database"],
  "metadata": {
    "dependency_notes": "Requires database for user session storage"
  }
}
```

## Integration Checklist

Перед релизом:

- [ ] `vibecraft integrate analyze` — без ошибок
- [ ] `vibecraft integrate build` — успешно
- [ ] Все интерфейсы сгенерированы
- [ ] Все коннекторы работают
- [ ] Integration тесты проходят
- [ ] Нет циклических зависимостей
- [ ] Build order определён

## See Also

- [MODULAR_MODE.md](./MODULAR_MODE.md) — Overview modular mode
- [MODULE_DEVELOPMENT.md](./MODULE_DEVELOPMENT.md) — Module development guide
- [MIGRATION_SIMPLE_TO_MODULAR.md](./MIGRATION_SIMPLE_TO_MODULAR.md) — Migration guide

---

*Vibecraft Framework v0.4 | Last updated: 2026-02-27*
